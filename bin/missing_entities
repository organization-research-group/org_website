#!/usr/bin/env node

const fs = require('fs')
    , path = require('path')
    , N3 = require('n3')
    , graphText = fs.readFileSync('graph.ttl', { encoding: 'utf8' })
    , { parseToPromise, nsExpander } = require('org-n3-utils')
    , parser = new N3.Parser()

const ROOT_DIR = path.dirname(__dirname)

// Map entity types to their target files
const TYPE_TO_FILE = {
  'foaf:Person': 'people.ttl',
  ':Publisher': 'publishers.ttl',
  'bibo:Proceedings': 'proceedings.ttl',
  'bibo:Conference': 'conferences.ttl',
}

// Default file for untyped entities (dc:isPartOf references)
const DEFAULT_FILE = 'volumes.ttl'

function getCheckList(prefixes) {
  const expandNS = nsExpander(prefixes)

  return new Map([
    [ expandNS('dc:creator'), expandNS('foaf:Person') ],
    [ expandNS('bibo:editor'), expandNS('foaf:Person') ],
    [ expandNS('bibo:translator'), expandNS('foaf:Person') ],
    [ expandNS('dc:isPartOf'), null ],
    [ expandNS('dc:publisher'), expandNS(':Publisher') ],
    [ expandNS('bibo:reproducedIn'), expandNS('bibo:Proceedings') ],
    [ expandNS('bibo:presentedAt'), expandNS('bibo:Conference') ],
  ])
}

async function main() {
  const { quads, prefixes } = await parseToPromise(parser, graphText)
      , store = new N3.Store()
      , check = getCheckList(prefixes)

  store.addQuads(quads)

  // Group missing entities by target file
  const missingByFile = new Map()

  Array.from(check).forEach(([ pred, type ]) => {
    const entries = store.getObjects(null, pred)

    entries.forEach(subj => {
      const count = store.countQuads(subj)

      if (count === 0) {
        const typeStr = type == null ? 'rdf:nil' : shorten(type.id, prefixes)
        const targetFile = TYPE_TO_FILE[typeStr] || DEFAULT_FILE
        const entity = formatEntity(subj, type, prefixes)

        if (!missingByFile.has(targetFile)) {
          missingByFile.set(targetFile, [])
        }
        missingByFile.get(targetFile).push(entity)
      }
    })
  })

  // Write to each file
  for (const [file, entities] of missingByFile) {
    const filePath = path.join(ROOT_DIR, file)
    const content = entities.join('')

    fs.appendFileSync(filePath, content)
    console.log(`Appended ${entities.length} missing entities to ${file}`)
  }

  if (missingByFile.size === 0) {
    console.log('No missing entities found.')
  }
}

function shorten(str, prefixes) {
  for (const [ prefix, uri ] of Object.entries(prefixes)) {
    if (str.startsWith(uri)) {
      return str.replace(uri, prefix + ':')
    }
  }

  return str
}

function formatEntity(node, type, prefixes) {
  return `
${shorten(node.id, prefixes)}
    # FILLME: Fill in missing entity
    a ${type == null ? 'rdf:nil' : shorten(type.id, prefixes)} .
`
}

main()
